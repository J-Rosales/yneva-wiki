---
const { config, frontmatter } = Astro.props;

function formatDate(value) {
  if (value === undefined || value === null || value === "") return null;
  if (typeof value === "number") return String(value);
  const raw = String(value).trim();
  if (/^\\d{4}$/.test(raw)) return raw;
  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(raw)) return raw;
  return raw;
}

function renderValue(field) {
  const value = frontmatter[field.key];
  if (value === undefined || value === null || value === "") return null;
  if (field.type === "date") {
    return formatDate(value);
  }
  if (field.type === "number") {
    const numberValue = typeof value === "number" ? value : Number(value);
    if (Number.isNaN(numberValue)) return String(value);
    return new Intl.NumberFormat().format(numberValue);
  }
  if (field.type === "boolean") {
    if (typeof value === "boolean") return value ? "Yes" : "No";
    const raw = String(value).trim().toLowerCase();
    if (raw === "true" || raw === "yes" || raw === "1") return "Yes";
    if (raw === "false" || raw === "no" || raw === "0") return "No";
    return String(value);
  }
  if (field.type === "slug") {
    const label = frontmatter[`${field.key}_label`];
    const text = label || value;
    return `<a href=\"/wiki/${value}/\">${text}</a>`;
  }
  if (field.type === "list") {
    if (Array.isArray(value)) {
      const items = value.map((v) => `<li>${v}</li>`).join("");
      return `<ul>${items}</ul>`;
    }
    return `<ul><li>${value}</li></ul>`;
  }
  if (field.type === "image") {
    const caption = frontmatter[`${field.key}_caption`];
    const fig = `<figure><img src=\"/media/${value}\" alt=\"\" />${
      caption ? `<figcaption>${caption}</figcaption>` : ""
    }</figure>`;
    return fig;
  }
  return String(value);
}

const rows = config.fields
  .map((field) => {
    const value = renderValue(field);
    if (!value) return null;
    return `<dt>${field.label}</dt><dd>${value}</dd>`;
  })
  .filter(Boolean)
  .join("");
---

<aside class="infobox">
  <header class="infobox__title">{config.title}</header>
  <dl set:html={rows}></dl>
</aside>

<style>
  .infobox {
    border: 1px solid #666;
    box-shadow: inset 0 0 0 8px var(--accent-soft);
    padding: 0.5rem;
    margin: 0 0 1rem 0;
  }
  .infobox__title {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  .infobox dt {
    font-weight: 600;
  }
  .infobox dd {
    margin: 0 0 0.5rem 0;
  }
</style>
