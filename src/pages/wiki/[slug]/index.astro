---
import articles from "../../../../build/articles.json" assert { type: "json" };
import placeholders from "../../../../build/placeholders.json" assert { type: "json" };
import { marked } from "marked";
import genealogy from "../../../../build/genealogy.json" assert { type: "json" };
import dynasties from "../../../../build/dynasties.json" assert { type: "json" };
import relatedContent from "../../../../build/related-content.json" assert { type: "json" };
import Navbox from "../../../components/Navbox.astro";
import navboxes from "../../../../build/navboxes.json" assert { type: "json" };
import infoboxes from "../../../../data/infoboxes/index.json" assert { type: "json" };
import Infobox from "../../../components/Infobox.astro";
import LayerToggle from "../../../components/LayerToggle.astro";
import FamilyTree from "../../../components/FamilyTree.astro";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import RelatedContent from "../../../components/RelatedContent.astro";
import CategoryTags from "../../../components/CategoryTags.astro";
import MetadataFooter from "../../../components/MetadataFooter.astro";

export function getStaticPaths() {
  const articlePaths = articles.map((article) => ({
    params: { slug: article.slug },
    props: { article, placeholder: null },
  }));
  const placeholderPaths = Object.keys(placeholders).map((slug) => ({
    params: { slug },
    props: { article: null, placeholder: placeholders[slug] },
  }));
  return [...articlePaths, ...placeholderPaths];
}

const { article, placeholder } = Astro.props;
if (!article && placeholder) {
  // Placeholder page is rendered below.
}
const html = article ? marked.parse(article.body) : "";
const rels = article ? genealogy[article.slug] || null : null;
const dynastyData = article ? dynasties[article.slug] || null : null;
const showLayers = article ? article.available_layers && article.available_layers.length > 1 : false;
const articlesBySlug = new Set(articles.map((a) => a.slug));
const articleTitleBySlug = new Map(articles.map((a) => [a.slug, a.title]));
const relatedForArticle = article ? relatedContent[article.slug] || [] : [];
const isDisambiguation = article ? article.type === "disambiguation" : false;
const disambiguationEntries =
  isDisambiguation && Array.isArray(article.frontmatter?.disambiguation_entries)
    ? article.frontmatter.disambiguation_entries
    : [];
const navboxRefs = article && Array.isArray(article.frontmatter?.navboxes) ? article.frontmatter.navboxes : [];
const navboxList = navboxRefs
  .map((ref) => {
    const match = navboxes.find((n) => n.id === ref.id);
    if (!match) return null;
    return { ...match, title: ref.title || match.title };
  })
  .filter(Boolean);
const infoboxConfig = article ? infoboxes.find((cfg) => cfg.type === article.type) || null : null;
const layerHtml = {};
if (article && article.layers) {
  for (const [layer, body] of Object.entries(article.layers)) {
    layerHtml[layer] = marked.parse(body);
  }
}

function unique(list) {
  return Array.from(new Set(list));
}

const parentParents =
  rels?.parents?.flatMap((p) => genealogy[p]?.parents || []) || [];
const childChildren =
  rels?.children?.flatMap((c) => genealogy[c]?.children || []) || [];

const extendedParents = unique(parentParents).filter((s) => !rels?.parents?.includes(s));
const extendedChildren = unique(childChildren).filter((s) => !rels?.children?.includes(s));
const dynastyMembers = dynastyData?.members || [];
const dynastyFounder = dynastyData?.founder || null;
const dynastyParent = dynastyData?.parent_house || null;
const dynastyChildren = dynastyData?.child_houses || [];
---

<BaseLayout
  title={article ? article.title : `Missing: ${placeholder.slug}`}
  layer={article ? article.default_layer : "default"}
  breadcrumbs={article ? [
    { href: "/", label: "Home" },
    { href: `/wiki/${article.slug}/`, label: article.title }
  ] : [
    { href: "/", label: "Home" },
    { href: `/wiki/${placeholder.slug}/`, label: placeholder.slug }
  ]}
  canonicalHref={article ? `/wiki/${article.slug}/` : null}
>
    <main class="wiki">
      {!article && placeholder && (
        <section class="placeholder-banner">
          <h1>Missing page: {placeholder.slug}</h1>
          <p>Oops! This page does not exist yet.</p>
          <p>{placeholder.description}</p>
          <h2>Backlinks</h2>
          <ul>
            {placeholder.backlinks.map((slug) => (
              <li><a href={`/wiki/${slug}/`}>{slug}</a></li>
            ))}
          </ul>
        </section>
      )}
      {article && !isDisambiguation && (
      <section class="wiki__content">
        <h1>{article.title}</h1>
        <p><strong>Type:</strong> {article.type}</p>
        <CategoryTags tags={article.frontmatter?.tags} />
        <article id="layer-body" data-pagefind-body set:html={html} />
        <MetadataFooter type={article.type} frontmatter={article.frontmatter} />
      </section>
      )}
      {article && isDisambiguation && (
        <section class="wiki__content">
          <h1>{article.title}</h1>
          <p>{article.frontmatter?.summary}</p>
          <h2>Articles</h2>
          {disambiguationEntries.length === 0 ? (
            <p>No entries listed.</p>
          ) : (
            <ul>
              {disambiguationEntries.map((slug) => (
                <li>
                  <a href={`/wiki/${slug}/`}>{articleTitleBySlug.get(slug) || `Missing: ${slug}`}</a>
                </li>
              ))}
            </ul>
          )}
        </section>
      )}
      <aside class="wiki__aside">
        {infoboxConfig && !isDisambiguation && (
          <Infobox config={infoboxConfig} frontmatter={article.frontmatter} />
        )}
        {showLayers && !isDisambiguation && (
          <LayerToggle
            slug={article.slug}
            layers={article.available_layers}
            layerHtml={layerHtml}
            activeLayer={article.default_layer}
          />
        )}
      </aside>
      {rels && !isDisambiguation && (
        <section>
          <h2>Genealogy</h2>
          <p><strong>Parents:</strong> {rels.parents?.join(", ") || "None"}</p>
          <p><strong>Spouses:</strong> {rels.spouses?.join(", ") || "None"}</p>
          <p><strong>Children:</strong> {rels.children?.join(", ") || "None"}</p>
          <p><strong>House:</strong> {rels.house || "None"}</p>
          <p><strong>Extended Parents:</strong> {extendedParents.join(", ") || "None"}</p>
          <p><strong>Extended Children:</strong> {extendedChildren.join(", ") || "None"}</p>
        </section>
      )}
      {article && article.type === "dynasty" && dynastyData && !isDisambiguation && (
        <section>
          <h2>Dynasty</h2>
          <p><strong>Founder:</strong> {dynastyFounder || "None"}</p>
          <p><strong>Parent House:</strong> {dynastyParent || "None"}</p>
          <p><strong>Child Houses:</strong> {dynastyChildren.join(", ") || "None"}</p>
          <h3>Members</h3>
          {dynastyMembers.length === 0 ? (
            <p>None listed.</p>
          ) : (
            <ul>
              {dynastyMembers.map((slug) => (
                <li>
                  <a href={`/wiki/${slug}/`}>{articleTitleBySlug.get(slug) || `Missing: ${slug}`}</a>
                </li>
              ))}
            </ul>
          )}
        </section>
      )}
      {rels && !isDisambiguation && (
        <section>
          <h2>Family Tree</h2>
          <FamilyTree slug={article.slug} />
        </section>
      )}
      {navboxList.length > 0 && !isDisambiguation && (
        <section>
          {navboxList.map((navbox) => (
            <Navbox navbox={navbox} articlesBySlug={articlesBySlug} />
          ))}
        </section>
      )}
      {!isDisambiguation && (
        <RelatedContent items={relatedForArticle} titleBySlug={articleTitleBySlug} />
      )}
    </main>
  <style>
    .wiki {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 1rem;
    }
    .wiki__aside {
      align-self: start;
    }
    .placeholder-banner {
      border: 1px solid #c00;
      padding: 0.75rem;
      background: #fff3f3;
    }
    @media (max-width: 900px) {
      .wiki {
        grid-template-columns: 1fr;
      }
      .wiki__aside {
        order: -1;
      }
    }
  </style>
</BaseLayout>
