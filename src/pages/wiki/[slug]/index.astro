---
import articles from "../../../../build/articles.json" assert { type: "json" };
import placeholders from "../../../../build/placeholders.json" assert { type: "json" };
import { marked } from "marked";
import genealogy from "../../../../build/genealogy.json" assert { type: "json" };
import Navbox from "../../../components/Navbox.astro";
import navboxes from "../../../../build/navboxes.json" assert { type: "json" };
import infoboxes from "../../../../data/infoboxes/index.json" assert { type: "json" };
import Infobox from "../../../components/Infobox.astro";
import LayerToggle from "../../../components/LayerToggle.astro";
import FamilyTree from "../../../components/FamilyTree.astro";
import BaseLayout from "../../../layouts/BaseLayout.astro";

export function getStaticPaths() {
  const articlePaths = articles.map((article) => ({
    params: { slug: article.slug },
    props: { article, placeholder: null },
  }));
  const placeholderPaths = Object.keys(placeholders).map((slug) => ({
    params: { slug },
    props: { article: null, placeholder: placeholders[slug] },
  }));
  return [...articlePaths, ...placeholderPaths];
}

const { article, placeholder } = Astro.props;
if (!article && placeholder) {
  // Placeholder page is rendered below.
}
const html = article ? marked.parse(article.body) : "";
const rels = article ? genealogy[article.slug] || null : null;
const showLayers = article ? article.available_layers && article.available_layers.length > 1 : false;
const articlesBySlug = new Set(articles.map((a) => a.slug));
const navboxRefs = article && Array.isArray(article.frontmatter?.navboxes) ? article.frontmatter.navboxes : [];
const navboxList = navboxRefs
  .map((ref) => {
    const match = navboxes.find((n) => n.id === ref.id);
    if (!match) return null;
    return { ...match, title: ref.title || match.title };
  })
  .filter(Boolean);
const infoboxConfig = article ? infoboxes.find((cfg) => cfg.type === article.type) || null : null;
const layerHtml = {};
if (article && article.layers) {
  for (const [layer, body] of Object.entries(article.layers)) {
    layerHtml[layer] = marked.parse(body);
  }
}

function unique(list) {
  return Array.from(new Set(list));
}

const parentParents =
  rels?.parents?.flatMap((p) => genealogy[p]?.parents || []) || [];
const childChildren =
  rels?.children?.flatMap((c) => genealogy[c]?.children || []) || [];

const extendedParents = unique(parentParents).filter((s) => !rels?.parents?.includes(s));
const extendedChildren = unique(childChildren).filter((s) => !rels?.children?.includes(s));
---

<BaseLayout
  title={article ? article.title : `Missing: ${placeholder.slug}`}
  layer={article ? article.default_layer : "default"}
  breadcrumbs={article ? [
    { href: "/", label: "Home" },
    { href: `/wiki/${article.slug}/`, label: article.title }
  ] : [
    { href: "/", label: "Home" },
    { href: `/wiki/${placeholder.slug}/`, label: placeholder.slug }
  ]}
  canonicalHref={article ? `/wiki/${article.slug}/` : null}
>
    <main class="wiki">
      {!article && placeholder && (
        <section class="placeholder-banner">
          <h1>Missing page: {placeholder.slug}</h1>
          <p>Oops! This page does not exist yet.</p>
          <p>{placeholder.description}</p>
          <h2>Backlinks</h2>
          <ul>
            {placeholder.backlinks.map((slug) => (
              <li><a href={`/wiki/${slug}/`}>{slug}</a></li>
            ))}
          </ul>
        </section>
      )}
      {article && (
      <section class="wiki__content">
        <h1>{article.title}</h1>
        <p><strong>Type:</strong> {article.type}</p>
        <article id="layer-body" data-pagefind-body set:html={html} />
      </section>
      )}
      <aside class="wiki__aside">
        {infoboxConfig && <Infobox config={infoboxConfig} frontmatter={article.frontmatter} />}
        {showLayers && (
          <LayerToggle
            slug={article.slug}
            layers={article.available_layers}
            layerHtml={layerHtml}
            activeLayer={article.default_layer}
          />
        )}
      </aside>
      {rels && (
        <section>
          <h2>Genealogy</h2>
          <p><strong>Parents:</strong> {rels.parents?.join(", ") || "None"}</p>
          <p><strong>Spouses:</strong> {rels.spouses?.join(", ") || "None"}</p>
          <p><strong>Children:</strong> {rels.children?.join(", ") || "None"}</p>
          <p><strong>House:</strong> {rels.house || "None"}</p>
          <p><strong>Extended Parents:</strong> {extendedParents.join(", ") || "None"}</p>
          <p><strong>Extended Children:</strong> {extendedChildren.join(", ") || "None"}</p>
        </section>
      )}
      {rels && (
        <section>
          <h2>Family Tree</h2>
          <FamilyTree slug={article.slug} />
        </section>
      )}
      {navboxList.length > 0 && (
        <section>
          {navboxList.map((navbox) => (
            <Navbox navbox={navbox} articlesBySlug={articlesBySlug} />
          ))}
        </section>
      )}
      <section>
        <h2>Related content</h2>
        <ul>
          <li>Related items will appear here.</li>
        </ul>
      </section>
    </main>
  <style>
    .wiki {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 1rem;
    }
    .wiki__aside {
      align-self: start;
    }
    .placeholder-banner {
      border: 1px solid #c00;
      padding: 0.75rem;
      background: #fff3f3;
    }
    @media (max-width: 900px) {
      .wiki {
        grid-template-columns: 1fr;
      }
      .wiki__aside {
        order: -1;
      }
    }
  </style>
</BaseLayout>
