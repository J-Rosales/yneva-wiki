---
import articles from "../../../../../build/articles.json" assert { type: "json" };
import { marked } from "marked";
import genealogy from "../../../../../build/genealogy.json" assert { type: "json" };
import Infobox from "../../../../components/Infobox.astro";
import infoboxes from "../../../../../data/infoboxes/index.json" assert { type: "json" };
import LayerToggle from "../../../../components/LayerToggle.astro";
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import CategoryTags from "../../../../components/CategoryTags.astro";
import MetadataFooter from "../../../../components/MetadataFooter.astro";

export function getStaticPaths() {
  const paths = [];
  for (const article of articles) {
    const layers = Object.keys(article.layers || {});
    for (const layer of layers) {
      paths.push({
        params: { slug: article.slug, layer },
        props: { article, layer },
      });
    }
  }
  return paths;
}

const { article, layer } = Astro.props;
const content = article.layers?.[layer] || article.base_body || article.body;
const html = marked.parse(content);
const rels = genealogy[article.slug] || null;
const showLayers = article.available_layers && article.available_layers.length > 1;
const infoboxConfig = infoboxes.find((cfg) => cfg.type === article.type) || null;
const layerHtml = {};
if (article.layers) {
  for (const [k, body] of Object.entries(article.layers)) {
    layerHtml[k] = marked.parse(body);
  }
}
---

<BaseLayout
  title={`${article.title} (${layer})`}
  layer={layer}
  breadcrumbs={[
    { href: "/", label: "Home" },
    { href: `/wiki/${article.slug}/`, label: article.title },
    { href: `/wiki/${article.slug}/${layer}/`, label: layer }
  ]}
  canonicalHref={`/wiki/${article.slug}/`}
  robots="noindex"
>
    <main class="wiki">
      <section class="wiki__content">
        <h1>{article.title}</h1>
        <p><strong>Type:</strong> {article.type}</p>
        <CategoryTags tags={article.frontmatter?.tags} />
        <article id="layer-body" data-pagefind-body set:html={html} />
        <MetadataFooter type={article.type} frontmatter={article.frontmatter} />
      </section>
      <aside class="wiki__aside">
        {infoboxConfig && <Infobox config={infoboxConfig} frontmatter={article.frontmatter} />}
        {showLayers && (
          <LayerToggle
            slug={article.slug}
            layers={article.available_layers}
            layerHtml={layerHtml}
            activeLayer={layer}
          />
        )}
      </aside>
      {rels && (
        <section>
          <h2>Genealogy</h2>
          <p><strong>Parents:</strong> {rels.parents?.join(", ") || "None"}</p>
          <p><strong>Spouses:</strong> {rels.spouses?.join(", ") || "None"}</p>
          <p><strong>Children:</strong> {rels.children?.join(", ") || "None"}</p>
          <p><strong>House:</strong> {rels.house || "None"}</p>
        </section>
      )}
    </main>
    <style>
      .wiki {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 1rem;
      }
      .wiki__aside {
        align-self: start;
      }
      @media (max-width: 900px) {
        .wiki {
          grid-template-columns: 1fr;
        }
        .wiki__aside {
          order: -1;
        }
      }
    </style>
</BaseLayout>
