---
import facets from "../../../build/facets.json" assert { type: "json" };
import articles from "../../../build/articles.json" assert { type: "json" };
import BaseLayout from "../../layouts/BaseLayout.astro";
const articleTypes = new Map(articles.map((a) => [a.slug, a.type]));
---

<BaseLayout title="Search" layer="default" breadcrumbs={[{ href: "/", label: "Home" }, { href: "/search/", label: "Search" }]}>
  <h1>Search</h1>
  <input id="query" type="search" placeholder="Search..." />
  <select id="typeFilter">
    <option value="">All types</option>
    {Array.from(new Set(facets.map((f) => f.type))).map((t) => (
      <option value={t}>{t}</option>
    ))}
  </select>
  <select id="tagFilter">
    <option value="">All tags</option>
    {Array.from(
      new Set(
        facets
          .flatMap((f) => Array.isArray(f.tags) ? f.tags : [])
          .filter(Boolean)
      )
    ).map((t) => (
      <option value={t}>{t}</option>
    ))}
  </select>
  <div id="tagPills" class="tag-pills"></div>
  <select id="layerFilter">
    <option value="">All layers</option>
    <option value="solar">solar</option>
    <option value="academic">academic</option>
  </select>
  <style>
    :root {
      --excerpt-length: 160;
    }
  </style>
  <style>
    #results span {
      font-size: 0.85em;
      padding: 0.1em 0.4em;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-right: 0.4em;
    }
    .tag-pills {
      margin: 0.5rem 0 0.75rem 0;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .tag-pill {
      padding: 0.2rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--tag-surface);
      cursor: pointer;
      font-size: 0.85rem;
    }
    .tag-pill.active {
      border-color: var(--accent-deep);
      background: var(--accent-soft);
    }
  </style>
  <div id="results"></div>

  <script type="module">
    const facets = JSON.parse(document.getElementById("facets-data").textContent);
    const articleTypes = JSON.parse(document.getElementById("article-types-data").textContent);
    const queryInput = document.getElementById("query");
    const typeFilter = document.getElementById("typeFilter");
    const tagFilter = document.getElementById("tagFilter");
    const layerFilter = document.getElementById("layerFilter");
    const results = document.getElementById("results");
    const tagPills = document.getElementById("tagPills");

    function getUrlState() {
      const params = new URLSearchParams(window.location.search);
      return {
        q: params.get("q") || "",
        type: params.get("type") || "",
        tag: params.get("tag") || "",
        layer: params.get("layer") || "",
      };
    }

    function setUrlState(q, type, tag, layer) {
      const params = new URLSearchParams();
      if (q) params.set("q", q);
      if (type) params.set("type", type);
      if (tag) params.set("tag", tag);
      if (layer) params.set("layer", layer);
      const next = `${window.location.pathname}?${params.toString()}`;
      history.replaceState(null, "", next);
    }

    async function search() {
      const q = queryInput.value.trim();
      const type = typeFilter.value;
      const tag = tagFilter.value;
      const layer = layerFilter.value;
      results.innerHTML = "";
      const existingCount = document.querySelector(".results-count");
      if (existingCount) existingCount.remove();
      setUrlState(q, type, tag, layer);
      if (!q) return;

      const pagefind = await import("/pagefind/pagefind.js");
      const searchResult = await pagefind.search(q);
      const data = await searchResult.results.map((r) => r.data());
      const items = await Promise.all(data);

      const filtered = items
        .map((item) => {
          const slug = item.url.replace("/wiki/", "").replace("/", "");
          const record = facets.find((f) => f.slug === slug);
          const type = articleTypes[slug];
          if (type === "disambiguation") return null;
          return { item, record };
        })
          .filter(Boolean)
          .filter(({ record }) => {
            if (!type) return true;
            if (type && record?.type !== type) return false;
            if (tag) {
              const tags = Array.isArray(record?.tags) ? record.tags : [];
              if (!tags.includes(tag)) return false;
            }
            if (layer) {
              if (!item.url.includes(`/${layer}/`)) return false;
            }
            return true;
          });

      if (filtered.length === 0) {
        results.innerHTML = "<p>No results. Try fewer filters.</p>";
        return;
      }

      const count = document.createElement("span");
      count.textContent = `${filtered.length} result(s)`;
      count.className = "results-count";
      queryInput.insertAdjacentElement("afterend", count);

      const sorted = filtered.slice().sort((a, b) => {
        const aTitle = a.item?.meta?.title?.toLowerCase?.() || "";
        const bTitle = b.item?.meta?.title?.toLowerCase?.() || "";
        const qLower = q.toLowerCase();
        const aExact = aTitle === qLower ? 1 : 0;
        const bExact = bTitle === qLower ? 1 : 0;
        if (aExact !== bExact) return bExact - aExact;
        const aIncludes = aTitle.includes(qLower) ? 1 : 0;
        const bIncludes = bTitle.includes(qLower) ? 1 : 0;
        if (aIncludes !== bIncludes) return bIncludes - aIncludes;
        return 0;
      });

      for (const { item, record } of sorted) {
        const el = document.createElement("div");
        const typeBadge = record?.type ? `<span>[${record.type}]</span>` : "";
        const tagBadges = Array.isArray(record?.tags)
          ? record.tags.map((t) => `<span>[${t}]</span>`).join(" ")
          : "";
        const layerBadge = item.url.includes("/solar/")
          ? `<span>[Sollerian Canon]</span>`
          : item.url.includes("/academic/")
          ? `<span>[Magocratic Canon]</span>`
          : "";
        const length = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--excerpt-length"), 10) || 160;
        const excerpt = item.excerpt.length > length ? item.excerpt.slice(0, length) + "â€¦" : item.excerpt;
        el.innerHTML = `<div>${typeBadge} ${tagBadges} ${layerBadge} <a href="${item.url}">${item.meta.title}</a></div><p>${excerpt}</p>`;
        results.appendChild(el);
      }
    }

    function renderTagPills() {
      if (!tagPills) return;
      const tags = Array.from(
        new Set(
          facets
            .flatMap((f) => Array.isArray(f.tags) ? f.tags : [])
            .filter(Boolean)
        )
      );
      tagPills.innerHTML = tags
        .map((tag) => `<button class="tag-pill" data-tag="${tag}" type="button">${tag}</button>`)
        .join("");
      tagPills.addEventListener("click", (event) => {
        const target = event.target;
        if (!target || !target.dataset || !target.dataset.tag) return;
        const selected = target.dataset.tag;
        if (tagFilter.value === selected) {
          tagFilter.value = "";
        } else {
          tagFilter.value = selected;
        }
        updateTagPills();
        search();
      });
      updateTagPills();
    }

    function updateTagPills() {
      if (!tagPills) return;
      const buttons = tagPills.querySelectorAll(".tag-pill");
      buttons.forEach((btn) => {
        const active = btn.dataset.tag === tagFilter.value;
        btn.classList.toggle("active", active);
      });
    }

    queryInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        search();
      }
    });
    queryInput.addEventListener("input", search);
    typeFilter.addEventListener("change", search);
    tagFilter.addEventListener("change", () => {
      updateTagPills();
      search();
    });
    layerFilter.addEventListener("change", search);

    const state = getUrlState();
    if (state.q) queryInput.value = state.q;
    if (state.type) typeFilter.value = state.type;
    if (state.tag) tagFilter.value = state.tag;
    if (state.layer) layerFilter.value = state.layer;
    renderTagPills();
    if (state.q) search();
  </script>

  <script
    type="application/json"
    id="facets-data"
    set:html={JSON.stringify(facets)}
  ></script>
  <script
    type="application/json"
    id="article-types-data"
    set:html={JSON.stringify(Object.fromEntries(articleTypes))}
  ></script>
</BaseLayout>
